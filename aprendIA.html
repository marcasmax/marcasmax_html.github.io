<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego Educativo con IA</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #6dd5ed, #2193b0);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Estilo para la barra de desplazamiento */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animación de carga */
        .loading-dots::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: black;
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow:
                    .25em 0 0 black,
                    .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow:
                    .25em 0 0 black,
                    .5em 0 0 black;
            }
        }
        /* Estilos para el botón de archivo */
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #4CAF50; /* Verde */
            color: white;
            border-radius: 9999px; /* Tailwind rounded-full */
            font-weight: 600; /* Tailwind font-semibold */
            transition: background-color 0.2s;
        }
        .custom-file-upload:hover {
            background-color: #45a049;
        }

        /* Estilos para el modal de la API Key y Quiz Topic*/
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .modal-content input[type="password"],
        .modal-content input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .modal-content button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px; /* Added margin for buttons */
        }
        .modal-content button:hover {
            background-color: #0056b3;
        }

        /* Estilos para Canvas dinámico */
        #dynamicVisualCanvas {
            border: 2px solid #ccc;
            background-color: #f9f9f9;
            margin-top: 10px;
            border-radius: 0.5rem;
            width: 100%; /* Make canvas responsive */
            height: auto; /* Maintain aspect ratio */
            max-width: 400px; /* Limit max width */
            display: block; /* Remove extra space below canvas */
            margin-left: auto;
            margin-right: auto;
        }
        #contentImage {
            width: 100%;
            height: auto;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Modal para la API Key -->
    <div id="apiKeyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">¡Bienvenido al Juego Educativo!</h2>
            <p class="mb-6 text-gray-600">Por favor, introduce tu clave de API de Gemini para comenzar. Esta clave no se guardará de forma permanente.</p>
            <input type="password" id="apiKeyInput" placeholder="Tu clave de API de Gemini..." class="focus:ring-2 focus:ring-blue-500 outline-none">
            <button id="saveApiKeyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md">Guardar y Empezar</button>
            <p class="text-sm text-gray-500 mt-4">¿No tienes una? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Obtén una aquí</a>.</p>
        </div>
    </div>

    <!-- Modal para la selección del tema del Quiz -->
    <div id="quizTopicModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">¿Sobre qué quieres el Quiz?</h2>
            <button id="quizTopicChatHistoryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md">Sobre lo que hemos hablado</button>
            <p class="my-4 text-gray-600">O</p>
            <input type="text" id="quizTopicInput" placeholder="Introduce un tema específico..." class="focus:ring-2 focus:ring-blue-500 outline-none">
            <button id="startSpecificQuizBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md">Iniciar Quiz sobre este tema</button>
        </div>
    </div>

    <!-- Contenedor principal del juego -->
    <div class="flex flex-col md:flex-row bg-white rounded-2xl shadow-xl w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Panel de chat/interacción -->
        <div class="flex-1 flex flex-col p-6 bg-gray-50 rounded-l-2xl border-r border-gray-200">
            <div class="flex-grow overflow-y-auto space-y-4 pr-2" id="chatArea">
                <!-- Mensajes del chat se insertarán aquí -->
                <!-- El mensaje inicial lo añade JS -->
            </div>

            <!-- ID del Usuario -->
            <div class="text-sm text-gray-600 mt-4 p-2 bg-gray-100 rounded-lg shadow-inner">
                Tu ID de usuario: <span id="userIdDisplay" class="font-semibold text-gray-800 truncate">Cargando...</span>
            </div>

            <!-- Área de entrada y botones de acción -->
            <div class="mt-6 flex flex-wrap items-center gap-3">
                <input type="text" id="userInput" placeholder="Escribe tu pregunta o respuesta..." class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 min-w-[150px]">
                <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 flex-shrink-0">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="voiceInputBtn" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 flex-shrink-0">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="stopSpeechBtn" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 flex-shrink-0">
                    <i class="fas fa-stop"></i>
                </button>
                <label for="fileInput" class="custom-file-upload flex-shrink-0">
                    <i class="fas fa-upload"></i>
                </label>
                <input type="file" id="fileInput" accept="image/*">
                <!-- Nuevos botones para funciones de Gemini API -->
                <button id="summarizeBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 flex-shrink-0">
                    ✨ Resumir Tema
                </button>
                <button id="generateNotesBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 flex-shrink-0">
                    ✨ Generar Notas
                </button>
            </div>
        </div>

        <!-- Panel de Quiz/Contenido Adicional -->
        <div class="flex-1 flex flex-col p-6 bg-blue-50 rounded-r-2xl">
            <h2 class="text-3xl font-bold text-blue-800 mb-6 text-center">Área de Aprendizaje Interactivo</h2>

            <div id="quizArea" class="flex-grow flex flex-col items-center justify-center bg-white p-6 rounded-xl shadow-lg text-gray-800 text-center">
                <p class="text-xl mb-4">Aquí aparecerán preguntas, imágenes y contenido educativo.</p>
                <img id="contentImage" src="https://placehold.co/400x300/e0e7ff/3f51b5?text=Contenido+Visual" alt="Contenido Visual" class="hidden rounded-lg shadow-md mb-4">
                <canvas id="dynamicVisualCanvas" width="400" height="300" class="hidden"></canvas>
                <div id="quizImageLoading" class="hidden loading-dots text-lg mt-4">Generando imagen para el quiz...</div>
                <div id="quizQuestion" class="text-2xl font-semibold mb-6 hidden"></div>
                <div id="quizOptions" class="flex flex-col space-y-3 w-full max-w-sm hidden">
                    <!-- Opciones del quiz se insertarán aquí -->
                </div>
                <button id="startQuizBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 mt-6">
                    Iniciar Quiz
                </button>
                <div id="quizFeedback" class="text-lg font-bold mt-4 hidden"></div>
                <button id="nextQuestionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 mt-4 hidden">
                    Siguiente Pregunta
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variables globales para Firebase y UI
        let app, db, auth;
        let currentUserId = null;
        let firebaseReady = false;
        let geminiApiKey = null;
        let chatHistory = [];
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let score = 0;

        // Referencias a elementos del DOM
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const stopSpeechBtn = document.getElementById('stopSpeechBtn');
        const fileInput = document.getElementById('fileInput');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const quizArea = document.getElementById('quizArea');
        const quizQuestionElem = document.getElementById('quizQuestion');
        const quizOptionsElem = document.getElementById('quizOptions');
        const quizFeedbackElem = document.getElementById('quizFeedback');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const contentImage = document.getElementById('contentImage');
        const dynamicVisualCanvas = document.getElementById('dynamicVisualCanvas');
        const quizImageLoading = document.getElementById('quizImageLoading'); // Loader para imágenes del quiz
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const generateNotesBtn = document.getElementById('generateNotesBtn');
        const quizTopicModal = document.getElementById('quizTopicModal');
        const quizTopicChatHistoryBtn = document.getElementById('quizTopicChatHistoryBtn');
        const quizTopicInput = document.getElementById('quizTopicInput');
        const startSpecificQuizBtn = document.getElementById('startSpecificQuizBtn');

        // Asegurar que el habla se detiene al recargar/cerrar la página
        window.addEventListener('beforeunload', () => {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        });

        // Mostrar modal al cargar la página o iniciar flujo
        window.onload = function() {
            const storedApiKey = sessionStorage.getItem('geminiApiKey');
            if (storedApiKey) {
                geminiApiKey = storedApiKey;
                initializeFirebase();
            } else {
                apiKeyModal.classList.remove('hidden');
            }
        };

        // Guardar API Key y continuar
        saveApiKeyBtn.addEventListener('click', async () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                geminiApiKey = key;
                sessionStorage.setItem('geminiApiKey', key); // Guardar temporalmente
                apiKeyModal.classList.add('hidden');
                await initializeFirebase();
                // El mensaje inicial se manejará en loadChatHistory si no hay historial
            } else {
                alertUser("Por favor, introduce tu clave de API de Gemini para continuar.");
            }
        });

        // Función para mostrar alertas personalizadas
        function alertUser(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl animate-fade-in-down z-[1001]';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.classList.add('animate-fade-out-up');
                alertDiv.addEventListener('animationend', () => alertDiv.remove());
            }, 3000);
        }

        // Función de inicialización de Firebase
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            currentUserId = auth.currentUser.uid;
                        } else {
                            await signInAnonymously(auth);
                            currentUserId = auth.currentUser.uid;
                        }
                    }

                    if (currentUserId) {
                        userIdDisplay.textContent = currentUserId;
                        firebaseReady = true;
                        console.log("Firebase inicializado. ID de usuario:", currentUserId);
                        loadChatHistory();
                    } else {
                        console.error("No se pudo obtener el ID de usuario de Firebase.");
                        userIdDisplay.textContent = "Error al cargar ID";
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                alertUser("Error al inicializar Firebase. Consulta la consola para más detalles.");
            }
        }

        // Cargar historial del chat desde Firestore
        function loadChatHistory() {
            if (!firebaseReady || !currentUserId) return;

            const chatRef = collection(db, `artifacts/${__app_id}/users/${currentUserId}/chat_history`);
            const q = query(chatRef, orderBy("timestamp"));

            onSnapshot(q, (snapshot) => {
                chatHistory = [];
                chatArea.innerHTML = ''; // Limpiar chat para reconstruir
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    chatHistory.push(message);
                    displayMessage(message.text, message.sender, message.imageUrl, message.sourceUrl);
                });
                // Si no se cargó historial o el historial está vacío, añadir el saludo inicial
                if (chatHistory.length === 0) {
                    const initialGreeting = "¡Hola! Soy tu asistente de aprendizaje. Dime, ¿sobre qué tema te gustaría aprender hoy o qué pregunta tienes?";
                    displayMessage(initialGreeting, 'ai');
                    speakText(initialGreeting);
                }
                chatArea.scrollTop = chatArea.scrollHeight;
            }, (error) => {
                console.error("Error al cargar historial del chat:", error);
                alertUser("Error al cargar el historial de chat.");
            });
        }

        // Guardar mensaje en Firestore
        async function saveMessage(text, sender, imageUrl = null, sourceUrl = null) {
            if (!firebaseReady || !currentUserId) {
                console.warn("Firebase no está listo, no se puede guardar el mensaje.");
                return;
            }
            try {
                const chatRef = collection(db, `artifacts/${__app_id}/users/${currentUserId}/chat_history`);
                await addDoc(chatRef, {
                    text: text,
                    sender: sender,
                    imageUrl: imageUrl,
                    sourceUrl: sourceUrl,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error("Error al guardar el mensaje:", error);
                alertUser("Error al guardar el mensaje en la base de datos.");
            }
        }

        // Mostrar mensaje en la UI del chat
        function displayMessage(text, sender, imageUrl = null, sourceUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'items-start'}`;

            const contentWrapper = document.createElement('div');
            contentWrapper.className = `flex flex-col max-w-[80%] ${sender === 'user' ? 'ml-auto items-end' : 'items-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `p-3 rounded-xl shadow-sm ${sender === 'user' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`;

            if (sender === 'ai') {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-sm mr-3';
                iconDiv.textContent = 'AI';
                messageDiv.appendChild(iconDiv);
            }

            const textNode = document.createElement('p');
            textNode.textContent = text;
            contentDiv.appendChild(textNode);

            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Imagen adjunta';
                img.className = 'mt-2 rounded-lg max-w-full h-auto';
                contentDiv.appendChild(img);
            }

            contentWrapper.appendChild(contentDiv);

            // Botón de Fuente para mensajes de AI
            if (sender === 'ai') {
                const sourceBtn = document.createElement('button');
                sourceBtn.className = 'text-xs text-blue-600 hover:underline mt-1 px-2 py-1 rounded-full bg-blue-50';
                sourceBtn.textContent = 'Fuente (general)';
                sourceBtn.onclick = () => {
                    alertUser("Como modelo de IA, mi conocimiento proviene de una vasta cantidad de texto y código. No puedo proporcionar una fuente única y específica para cada pieza de información, pero puedo intentar darte términos de búsqueda relacionados.");
                };
                contentWrapper.appendChild(sourceBtn);
            }

            messageDiv.appendChild(contentWrapper);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Función para generar una imagen con la API de Imagen
        async function generateImageWithAI(prompt, targetImageElement = null) {
            // Mostrar indicador de carga apropiado
            if (targetImageElement === contentImage) { // If generating for quiz
                quizImageLoading.classList.remove('hidden');
                contentImage.classList.add('hidden'); // Hide any previous quiz image
                dynamicVisualCanvas.classList.add('hidden'); // Hide canvas
            } else { // If generating for chat
                showLoadingIndicator();
            }

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = ""; // La plataforma de Canvas la provee automáticamente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (targetImageElement === contentImage) {
                    quizImageLoading.classList.add('hidden'); // Hide quiz image loader
                } else {
                    hideLoadingIndicator(); // Hide chat loader
                }

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    if (targetImageElement) { // Si es para el quiz area
                        targetImageElement.src = imageUrl;
                        targetImageElement.classList.remove('hidden');
                    } else { // Si es para el chat
                        displayMessage(`[Imagen Generada: ${prompt}]`, 'ai', imageUrl);
                        saveMessage(`[Imagen Generada: ${prompt}]`, 'ai', imageUrl);
                    }
                    speakText("He generado una imagen para ti.");
                } else {
                    if (targetImageElement) {
                        alertUser("No se pudo generar la imagen para el quiz.");
                        console.error("Estructura de respuesta de imagen inesperada para quiz:", result);
                    } else {
                        displayMessage("Error: No se pudo generar la imagen.", 'ai');
                        saveMessage("Error: No se pudo generar la imagen.", 'ai');
                        console.error("Estructura de respuesta de imagen inesperada:", result);
                    }
                }
            } catch (error) {
                if (targetImageElement === contentImage) {
                    quizImageLoading.classList.add('hidden');
                } else {
                    hideLoadingIndicator();
                }
                console.error("Error al generar la imagen con la API de Imagen:", error);
                if (targetImageElement) {
                    alertUser("Error al generar la imagen para el quiz. Inténtalo de nuevo más tarde.");
                } else {
                    displayMessage("Error al generar la imagen. Inténtalo de nuevo más tarde.", 'ai');
                    saveMessage("Error al generar la imagen.", 'ai');
                }
            }
        }


        // Función para enviar mensaje al modelo Gemini (para texto y detección de comandos)
        async function sendMessageToGemini(text, imageData = null, isSystemPrompt = false, currentChatHistoryForContext = []) {
            if (!geminiApiKey) {
                alertUser("Clave de API de Gemini no configurada. Por favor, introducela.");
                apiKeyModal.classList.remove('hidden');
                return;
            }

            // Pausar el habla antes de enviar un nuevo mensaje a la IA
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            if (!isSystemPrompt) {
                displayMessage(text, 'user');
                saveMessage(text, 'user');
                userInput.value = '';
            }
            showLoadingIndicator();

            let payloadContent = [];
            // Transformar chatHistory para el modelo (role 'user'/'model')
            if (currentChatHistoryForContext.length > 0) {
                payloadContent = currentChatHistoryForContext.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));
            }
            
            let finalPromptText = text;
            // Instrucciones para una "plática" amigable y progresiva
            if (!isSystemPrompt && !currentChatHistoryForContext.length) {
                finalPromptText = `Responde de forma no técnica, concisa y amigable. Introduce un tema, da un ejemplo sencillo y luego haz una pregunta relacionada para que el usuario continúe la conversación. No des toda la información de golpe; divídela en interacciones. Si el usuario pregunta algo, responde solo lo básico y haz una pregunta para seguir. Si puedes, sugiere la generación de una imagen si es relevante para el concepto, usando el formato "GENERATE_IMAGE: [descripción detallada de la imagen]".\n\nUsuario: ${text}`;
            }

            payloadContent.push({ role: "user", parts: [{ text: finalPromptText }] });

            if (imageData) {
                payloadContent[payloadContent.length - 1].parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: imageData
                    }
                });
            }

            const payload = {
                contents: payloadContent
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                hideLoadingIndicator();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let aiText = result.candidates[0].content.parts[0].text;
                    
                    // 1. Procesar el comando de generación de IMAGEN
                    const generateImageRegex = /GENERATE_IMAGE:\s*\[(.*?)\]/;
                    const generateImageMatch = aiText.match(generateImageRegex);
                    if (generateImageMatch && generateImageMatch[1]) {
                        const imagePrompt = generateImageMatch[1].trim();
                        aiText = aiText.replace(generateImageMatch[0], '').trim(); // Eliminar el comando del texto visible
                        
                        if (aiText) { // Mostrar texto restante si existe antes de generar la imagen
                            displayMessage(aiText, 'ai');
                            saveMessage(aiText, 'ai');
                            speakText(aiText);
                        }
                        generateImageWithAI(imagePrompt); // Llamar a la función de generación de imagen
                        return; // Salir, ya que la imagen se mostrará por separado
                    }

                    // 2. Procesar el JSON del Quiz
                    const quizRegex = /```json\s*(\{[\s\S]*?\})\s*```/;
                    const quizMatch = aiText.match(quizRegex);
                    if (quizMatch && quizMatch[1]) {
                        try {
                            const quizData = JSON.parse(quizMatch[1]);
                            if (quizData.type === "quiz" && quizData.questions) {
                                startQuiz(quizData);
                                aiText = aiText.replace(quizMatch[0], '').trim(); // Eliminar el JSON del texto visible
                                if (aiText) { // Mostrar cualquier texto restante
                                    displayMessage(aiText, 'ai');
                                    saveMessage(aiText, 'ai');
                                    speakText(aiText);
                                }
                                return; // Salir, el quiz ya se inició
                            }
                        } catch (parseError) {
                            console.warn("No se pudo parsear el quiz desde la respuesta AI:", parseError);
                        }
                    }

                    // 3. Si no es un comando de imagen ni un quiz, mostrar el mensaje normal
                    displayMessage(aiText, 'ai');
                    saveMessage(aiText, 'ai');
                    speakText(aiText);

                } else {
                    displayMessage("Error: No se pudo obtener una respuesta del modelo AI.", 'ai');
                    saveMessage("Error: No se pudo obtener una respuesta del modelo AI.", 'ai');
                    console.error("Estructura de respuesta inesperada:", result);
                }
            } catch (error) {
                hideLoadingIndicator();
                console.error("Error al comunicarse con la API de Gemini:", error);
                displayMessage("Error al comunicarse con la IA. Por favor, revisa tu clave de API y tu conexión.", 'ai');
                saveMessage("Error al comunicarse con la IA.", 'ai');
            }
        }

        // Indicador de carga
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'flex items-center space-x-2 p-3 bg-gray-200 text-gray-700 rounded-xl max-w-fit shadow-sm mt-4';
            loadingDiv.innerHTML = '<div class="loading-dots">AI está pensando</div>';
            chatArea.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // --- Funcionalidad de Voz (Speech Recognition y Speech Synthesis) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const SpeechSynthesis = window.speechSynthesis;

        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Solo escucha una vez
            recognition.lang = 'es-ES'; // Idioma español

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessageToGemini(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Error en el reconocimiento de voz:', event.error);
                alertUser("Error en el reconocimiento de voz. Asegúrate de tener micrófono.");
                voiceInputBtn.classList.remove('bg-red-500');
                voiceInputBtn.classList.add('bg-purple-600');
            };

            recognition.onend = () => {
                voiceInputBtn.classList.remove('bg-red-500');
                voiceInputBtn.classList.add('bg-purple-600');
            };

            voiceInputBtn.addEventListener('click', () => {
                try {
                    voiceInputBtn.classList.add('bg-red-500'); // Indicador de que está escuchando
                    voiceInputBtn.classList.remove('bg-purple-600');
                    recognition.start();
                    alertUser("Habla ahora...");
                } catch (e) {
                    console.error("Error al iniciar el reconocimiento de voz:", e);
                    alertUser("No se pudo iniciar el reconocimiento de voz. Asegúrate de que el navegador lo soporte.");
                    voiceInputBtn.classList.remove('bg-red-500');
                    voiceInputBtn.classList.add('bg-purple-600');
                }
            });
        } else {
            voiceInputBtn.disabled = true;
            voiceInputBtn.textContent = 'Voz no soportada';
            voiceInputBtn.title = 'Tu navegador no soporta el reconocimiento de voz';
            console.warn('Reconocimiento de voz no soportado en este navegador.');
        }

        function speakText(text) {
            if (SpeechSynthesis) {
                // Detener cualquier habla actual antes de iniciar una nueva
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Idioma español
                SpeechSynthesis.speak(utterance);
            } else {
                console.warn('Síntesis de voz no soportada en este navegador.');
            }
        }

        // Botón para detener el habla
        stopSpeechBtn.addEventListener('click', () => {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                alertUser("Se ha detenido la voz.");
            } else {
                alertUser("No hay voz reproduciéndose.");
            }
        });


        // --- Manejo de archivos (Imágenes) ---
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result.split(',')[1]; // Obtener solo la parte base64
                    const prompt = "Describe esta imagen y haz una pregunta educativa relacionada con ella.";
                    displayMessage(`[Imagen Adjunta] ${prompt}`, 'user', e.target.result); // Mostrar imagen en chat
                    saveMessage(`[Imagen Adjunta] ${prompt}`, 'user', e.target.result);
                    sendMessageToGemini(prompt, base64Image);
                };
                reader.readAsDataURL(file);
            } else {
                alertUser("Por favor, sube solo archivos de imagen.");
            }
        });

        // --- Lógica del Quiz ---
        startQuizBtn.addEventListener('click', () => {
            if (!geminiApiKey) {
                alertUser("Clave de API de Gemini no configurada. Por favor, introducela.");
                apiKeyModal.classList.remove('hidden');
                return;
            }
            quizTopicModal.classList.remove('hidden'); // Mostrar modal de selección de tema
        });

        quizTopicChatHistoryBtn.addEventListener('click', () => {
            quizTopicModal.classList.add('hidden');
            quizArea.innerHTML = `
                <div class="text-xl mb-4">Generando un quiz sobre nuestra conversación...</div>
                <div class="loading-dots text-lg"></div>
            `;
            const chatTranscript = chatHistory.map(msg => `${msg.sender === 'user' ? 'Usuario' : 'Modelo'}: ${msg.text}`).join('\n');
            const quizPrompt = `Genera un quiz de opción múltiple de 3 preguntas basado estrictamente en el siguiente historial de conversación, SIN incluir información externa. Las preguntas deben ser del mismo nivel de dificultad de la conversación y no más difíciles. Para cada pregunta, incluye la pregunta, cuatro opciones (A, B, C, D), la letra de la respuesta correcta. Si la pregunta requiere un concepto visual, puedes incluir una propiedad 'dynamicVisual' con uno de los siguientes valores: "double_house" (para el doble de tamaño, como una casa y su versión doble), "pizza_slices" (para rebanadas de pizza faltantes, con 6 rebanadas totales y 2 faltantes de ejemplo), "square_halved" (para dividir un cuadrado por la mitad), "bar_chart:[val1],[val2],..." (para un gráfico de barras, ej: "bar_chart:60,40"). También puedes incluir una propiedad 'generateImagePrompt' con una descripción concisa para generar una imagen más compleja, por ejemplo "generateImagePrompt": "una célula vegetal". NO uses 'imageUrlDescription' y 'dynamicVisual' o 'generateImagePrompt' en la misma pregunta. Formatea la respuesta como un JSON markdown:
            \`\`\`json
            {
                "type": "quiz",
                "questions": [
                    {
                        "question": "¿Cuál es la capital de Francia?",
                        "options": ["A) Roma", "B) París", "C) Madrid", "D) Berlín"],
                        "correctAnswer": "B"
                    },
                    {
                        "question": "¿Si una casa mide 10 metros, cuánto es el doble de su tamaño?",
                        "options": ["A) 15 metros", "B) 20 metros", "C) 30 metros", "D) 5 metros"],
                        "correctAnswer": "B",
                        "dynamicVisual": "double_house"
                    },
                    {
                        "question": "Una pizza se divide en 6 rebanadas. Si se quitan 2 rebanadas, ¿cuántas quedan?",
                        "options": ["A) 2", "B) 3", "C) 4", "D) 5"],
                        "correctAnswer": "C",
                        "dynamicVisual": "pizza_slices"
                    },
                     {
                        "question": "¿Qué fracción representa la mitad de un cuadrado?",
                        "options": ["A) 1/4", "B) 1/2", "C) 3/4", "D) 1/3"],
                        "correctAnswer": "B",
                        "dynamicVisual": "square_halved"
                    },
                     {
                        "question": "Si tienes 60% de un pastel y tu amigo el 40%, ¿quién tiene más?",
                        "options": ["A) Tú", "B) Tu amigo", "C) Ambos tienen igual", "D) Falta información"],
                        "correctAnswer": "A",
                        "dynamicVisual": "bar_chart:60,40"
                    },
                    {
                        "question": "¿Cuál es el planeta más grande de nuestro sistema solar?",
                        "options": ["A) Marte", "B) Tierra", "C) Júpiter", "D) Saturno"],
                        "correctAnswer": "C",
                        "generateImagePrompt": "El planeta Júpiter en el espacio con sus lunas"
                    }
                ]
            }
            \`\`\`
            Historial de conversación:\n${chatTranscript}`;
            sendMessageToGemini(quizPrompt, null, true, chatHistory); // Pasar chatHistory como contexto
        });

        startSpecificQuizBtn.addEventListener('click', () => {
            const topic = quizTopicInput.value.trim();
            if (!topic) {
                alertUser("Por favor, introduce un tema para el quiz o selecciona 'Sobre lo que hemos hablado'.");
                return;
            }
            quizTopicModal.classList.add('hidden');
            quizArea.innerHTML = `
                <div class="text-xl mb-4">Generando un quiz sobre "${topic}"...</div>
                <div class="loading-dots text-lg"></div>
            `;
            const quizPrompt = `Genera un quiz de opción múltiple de 3 preguntas sobre el tema "${topic}". Las preguntas deben ser educativas, concisas y no técnicas, adecuadas para un estudiante. Si la pregunta requiere un concepto visual, puedes incluir una propiedad 'dynamicVisual' con uno de los siguientes valores: "double_house" (para el doble de tamaño, como una casa y su versión doble), "pizza_slices" (para rebanadas de pizza faltantes, con 6 rebanadas totales y 2 faltantes de ejemplo), "square_halved" (para dividir un cuadrado por la mitad), "bar_chart:[val1],[val2],..." (para un gráfico de barras, ej: "bar_chart:60,40"). También puedes incluir una propiedad 'generateImagePrompt' con una descripción concisa para generar una imagen más compleja, por ejemplo "generateImagePrompt": "una célula vegetal". NO uses 'imageUrlDescription' y 'dynamicVisual' o 'generateImagePrompt' en la misma pregunta. Formatea la respuesta como un JSON markdown:
            \`\`\`json
            {
                "type": "quiz",
                "questions": [
                    {
                        "question": "¿Cuál es la capital de Francia?",
                        "options": ["A) Roma", "B) París", "C) Madrid", "D) Berlín"],
                        "correctAnswer": "B"
                    },
                     {
                        "question": "¿Si una casa mide 10 metros, cuánto es el doble de su tamaño?",
                        "options": ["A) 15 metros", "B) 20 metros", "C) 30 metros", "D) 5 metros"],
                        "correctAnswer": "B",
                        "dynamicVisual": "double_house"
                    },
                    {
                        "question": "Una pizza se divide en 6 rebanadas. Si se quitan 2 rebanadas, ¿cuántas quedan?",
                        "options": ["A) 2", "B) 3", "C) 4", "D) 5"],
                        "correctAnswer": "C",
                        "dynamicVisual": "pizza_slices"
                    },
                     {
                        "question": "¿Qué fracción representa la mitad de un cuadrado?",
                        "options": ["A) 1/4", "B) 1/2", "C) 3/4", "D) 1/3"],
                        "correctAnswer": "B",
                        "dynamicVisual": "square_halved"
                    },
                     {
                        "question": "Si tienes 60% de un pastel y tu amigo el 40%, ¿quién tiene más?",
                        "options": ["A) Tú", "B) Tu amigo", "C) Ambos tienen igual", "D) Falta información"],
                        "correctAnswer": "A",
                        "dynamicVisual": "bar_chart:60,40"
                    },
                    {
                        "question": "¿Cuál es el planeta más grande de nuestro sistema solar?",
                        "options": ["A) Marte", "B) Tierra", "C) Júpiter", "D) Saturno"],
                        "correctAnswer": "C",
                        "generateImagePrompt": "El planeta más grande del sistema solar, Júpiter, con sus bandas de nubes y la Gran Mancha Roja, flotando en el espacio oscuro."
                    }
                ]
            }
            \`\`\``;
            sendMessageToGemini(quizPrompt, null, true);
        });


        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuiz.questions.length) {
                displayQuestion(currentQuiz.questions[currentQuestionIndex]);
                quizFeedbackElem.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
            } else {
                endQuiz();
            }
        });

        function startQuiz(quizData) {
            currentQuiz = quizData;
            currentQuestionIndex = 0;
            score = 0;
            quizArea.innerHTML = ''; // Limpiar el área del quiz
            quizFeedbackElem.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            quizQuestionElem.classList.remove('hidden');
            quizOptionsElem.classList.remove('hidden');
            startQuizBtn.classList.add('hidden');
            contentImage.classList.add('hidden'); // Ocultar imagen si se muestra
            dynamicVisualCanvas.classList.add('hidden'); // Ocultar canvas
            quizImageLoading.classList.add('hidden'); // Ocultar loader de imagen del quiz

            displayQuestion(currentQuiz.questions[currentQuestionIndex]);
        }

        function displayQuestion(question) {
            quizQuestionElem.textContent = question.question;
            quizOptionsElem.innerHTML = '';
            contentImage.classList.add('hidden'); // Resetear imagen
            dynamicVisualCanvas.classList.add('hidden'); // Resetear canvas
            quizImageLoading.classList.add('hidden'); // Resetear loader

            // Manejar imágenes o visuales dinámicos para el quiz
            if (question.generateImagePrompt) {
                generateImageWithAI(question.generateImagePrompt, contentImage); // Generar imagen para el quiz area
            } else if (question.dynamicVisual === "double_house") {
                dynamicVisualCanvas.classList.remove('hidden');
                drawDoubleHouse(dynamicVisualCanvas);
            } else if (question.dynamicVisual === "pizza_slices") {
                dynamicVisualCanvas.classList.remove('hidden');
                drawPizzaSlices(dynamicVisualCanvas, 6, 2); // Ejemplo: 6 rebanadas, 2 quitadas
            } else if (question.dynamicVisual === "square_halved") {
                dynamicVisualCanvas.classList.remove('hidden');
                drawSquareHalved(dynamicVisualCanvas);
            } else if (question.dynamicVisual && question.dynamicVisual.startsWith("bar_chart:")) {
                const valuesStr = question.dynamicVisual.split(":")[1];
                const values = valuesStr.split(',').map(Number);
                if (values.every(val => !isNaN(val))) {
                    dynamicVisualCanvas.classList.remove('hidden');
                    drawBarChart(dynamicVisualCanvas, values);
                }
            } else {
                // Si no hay visuales específicos, asegurarse de que el placeholder inicial esté visible si es necesario
                // Pero para preguntas de quiz, si no hay visual, simplemente no mostrar nada.
            }

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out transform hover:scale-105';
                button.textContent = option;
                button.dataset.option = option.charAt(0); // 'A', 'B', 'C', 'D'
                button.addEventListener('click', () => checkAnswer(button, question.correctAnswer));
                quizOptionsElem.appendChild(button);
            });
        }

        // Función para dibujar una casa y su doble en el canvas
        function drawDoubleHouse(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth; // Set canvas size to match CSS
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar canvas
            ctx.font = '16px Inter';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#333';

            const baseSize = Math.min(canvas.width, canvas.height) / 4;
            const originalX = canvas.width / 4;
            const originalY = canvas.height / 2 + baseSize / 2;

            // Casa original (10m)
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#FFDDC1'; // Color claro para la casa
            ctx.beginPath();
            ctx.rect(originalX - baseSize / 2, originalY - baseSize, baseSize, baseSize); // Cuerpo
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(originalX - baseSize / 2, originalY - baseSize);
            ctx.lineTo(originalX, originalY - baseSize * 1.5); // Techo
            ctx.lineTo(originalX + baseSize / 2, originalY - baseSize);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.fillText('10m', originalX, originalY + 15);

            const doubleSize = baseSize * 2;
            const doubleX = canvas.width * 3 / 4;
            const doubleY = canvas.height / 2 + doubleSize / 2;

            // Casa duplicada (20m)
            ctx.fillStyle = '#C1FFDD'; // Otro color para la casa doble
            ctx.beginPath();
            ctx.rect(doubleX - doubleSize / 2, doubleY - doubleSize, doubleSize, doubleSize); // Cuerpo
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(doubleX - doubleSize / 2, doubleY - doubleSize);
            ctx.lineTo(doubleX, doubleY - doubleSize * 1.5); // Techo
            ctx.lineTo(doubleX + doubleSize / 2, doubleY - doubleSize);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.fillText('20m', doubleX, doubleY + 15);
        }

        // Función para dibujar pizza con rebanadas faltantes
        function drawPizzaSlices(canvas, totalSlices, removedSlices) {
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7; // Make it fit
            const sliceAngle = (2 * Math.PI) / totalSlices;

            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;

            for (let i = 0; i < totalSlices; i++) {
                const startAngle = i * sliceAngle;
                const endAngle = (i + 1) * sliceAngle;

                if (i < removedSlices) { // Dibujar las rebanadas quitadas con un color diferente o dejar un espacio
                    ctx.fillStyle = '#EEE'; // Color para espacio vacío
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    // Opcional: Dibujar una X o texto indicando que falta
                    ctx.fillStyle = '#AAA';
                    ctx.font = '20px Inter';
                    const midAngle = startAngle + sliceAngle / 2;
                    const textX = centerX + Math.cos(midAngle) * (radius / 2);
                    const textY = centerY + Math.sin(midAngle) * (radius / 2);
                    ctx.fillText('X', textX, textY);

                } else {
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = '#FFDDC1'; // Color de la pizza
                    ctx.fill();
                    ctx.stroke();
                }
            }
        }

        // Función para dibujar un cuadrado partido por la mitad
        function drawSquareHalved(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const size = Math.min(canvas.width, canvas.height) * 0.6;
            const x = (canvas.width - size) / 2;
            const y = (canvas.height - size) / 2;

            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#ADD8E6'; // Light blue

            // Draw the full square
            ctx.beginPath();
            ctx.rect(x, y, size, size);
            ctx.fill();
            ctx.stroke();

            // Draw line to halve it (e.g., vertically)
            ctx.beginPath();
            ctx.moveTo(x + size / 2, y);
            ctx.lineTo(x + size / 2, y + size);
            ctx.stroke();

            ctx.font = '24px Inter';
            ctx.fillStyle = '#333';
            ctx.fillText('1/2', x + size / 4, y + size / 2 + 8);
            ctx.fillText('1/2', x + size * 3 / 4, y + size / 2 + 8);
        }

        // Función para dibujar un gráfico de barras simple
        function drawBarChart(canvas, values) { // values: e.g., [60, 40]
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const chartHeight = canvas.height * 0.6;
            const barWidth = (canvas.width * 0.7) / values.length;
            const startY = canvas.height - 50;

            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            ctx.font = '16px Inter';
            ctx.textAlign = 'center';

            let currentX = (canvas.width - (barWidth * values.length + 20 * (values.length - 1))) / 2; // Center bars
            values.forEach((value, index) => {
                const barHeight = (value / 100) * chartHeight;
                ctx.fillStyle = index % 2 === 0 ? '#87CEEB' : '#FFD700'; // Blue, Gold

                ctx.beginPath();
                ctx.rect(currentX, startY - barHeight, barWidth - 10, barHeight); // Slightly smaller width for gap
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#333';
                ctx.fillText(`${value}%`, currentX + (barWidth - 10) / 2, startY - barHeight - 10);
                currentX += barWidth;
            });
            ctx.fillText('Eje Y (%)', 20, startY / 2);
            ctx.beginPath();
            ctx.moveTo(40, startY);
            ctx.lineTo(40, startY - chartHeight - 20);
            ctx.stroke();
        }

        // Listener para redimensionar el canvas con la ventana
        window.addEventListener('resize', () => {
            if (!dynamicVisualCanvas.classList.contains('hidden') && currentQuiz && currentQuiz.questions[currentQuestionIndex]) {
                const question = currentQuiz.questions[currentQuestionIndex];
                if (question.dynamicVisual === "double_house") {
                    drawDoubleHouse(dynamicVisualCanvas);
                } else if (question.dynamicVisual === "pizza_slices") {
                    drawPizzaSlices(dynamicVisualCanvas, 6, 2);
                } else if (question.dynamicVisual === "square_halved") {
                    drawSquareHalved(dynamicVisualCanvas);
                } else if (question.dynamicVisual && question.dynamicVisual.startsWith("bar_chart:")) {
                    const valuesStr = question.dynamicVisual.split(":")[1];
                    const values = valuesStr.split(',').map(Number);
                    if (values.every(val => !isNaN(val))) {
                        drawBarChart(dynamicVisualCanvas, values);
                    }
                }
            }
        });


        function checkAnswer(selectedButton, correctAnswer) {
            const selectedOption = selectedButton.dataset.option;
            // Deshabilitar todas las opciones después de una selección
            Array.from(quizOptionsElem.children).forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                quizFeedbackElem.textContent = "¡Correcto! 🎉";
                quizFeedbackElem.className = 'text-lg font-bold mt-4 text-green-600';
                score++;
            } else {
                quizFeedbackElem.textContent = `Incorrecto. La respuesta correcta era ${correctAnswer}.`;
                quizFeedbackElem.className = 'text-lg font-bold mt-4 text-red-600';
            }
            quizFeedbackElem.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }

        function endQuiz() {
            quizArea.innerHTML = `
                <h3 class="text-3xl font-bold text-blue-800 mb-4">Quiz Terminado</h3>
                <p class="text-xl text-gray-700">Tu puntuación final: ${score} de ${currentQuiz.questions.length}</p>
                <button id="restartQuizBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 mt-6">
                    Volver a Jugar
                </button>
            `;
            const restartQuizBtn = document.getElementById('restartQuizBtn');
            restartQuizBtn.addEventListener('click', () => {
                startQuizBtn.classList.remove('hidden'); // Mostrar botón de iniciar quiz
                // Restaurar el contenido inicial del quizArea
                quizArea.innerHTML = `<p class="text-xl mb-4">Aquí aparecerán preguntas, imágenes y contenido educativo.</p><img id="contentImage" src="https://placehold.co/400x300/e0e7ff/3f51b5?text=Contenido+Visual" alt="Contenido Visual" class="hidden rounded-lg shadow-md mb-4"><canvas id="dynamicVisualCanvas" width="400" height="300" class="hidden"></canvas><div id="quizImageLoading" class="hidden loading-dots text-lg mt-4">Generando imagen para el quiz...</div><div id="quizQuestion" class="text-2xl font-semibold mb-6 hidden"></div><div id="quizOptions" class="flex flex-col space-y-3 w-full max-w-sm hidden"></div><button id="startQuizBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 mt-6">Iniciar Quiz</button><div id="quizFeedback" class="text-lg font-bold mt-4 hidden"></div><button id="nextQuestionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 mt-4 hidden"></button>`;
                // Re-obtener las referencias a los elementos después de recrear el HTML
                document.getElementById('contentImage').classList.add('hidden'); // Asegurarse de que esté oculto
                document.getElementById('dynamicVisualCanvas').classList.add('hidden'); // Asegurarse de que el canvas esté oculto
                document.getElementById('quizImageLoading').classList.add('hidden');
                document.getElementById('quizQuestion').classList.add('hidden');
                document.getElementById('quizOptions').classList.add('hidden');
                document.getElementById('quizFeedback').classList.add('hidden');
                document.getElementById('nextQuestionBtn').classList.add('hidden');
                // IMPORTANTE: el startQuizBtn se muestra en el innerHTML y ya tiene su listener.
                currentQuiz = null;
            });
            nextQuestionBtn.classList.add('hidden');
            quizQuestionElem.classList.add('hidden');
            quizOptionsElem.classList.add('hidden');
            contentImage.classList.add('hidden');
            dynamicVisualCanvas.classList.add('hidden');
            quizImageLoading.classList.add('hidden');
        }

        // --- Event Listeners Globales ---
        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (text) {
                sendMessageToGemini(text);
            }
        });

        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendBtn.click();
            }
        });

        // --- Funciones de la API de Gemini ---

        // Botón "Resumir Tema"
        summarizeBtn.addEventListener('click', () => {
            if (!geminiApiKey) {
                alertUser("Clave de API de Gemini no configurada. Por favor, introducela.");
                apiKeyModal.classList.remove('hidden');
                return;
            }

            const chatTranscript = chatHistory.map(msg => `${msg.sender === 'user' ? 'Tú' : 'AI'}: ${msg.text}`).join('\n');
            const summaryPrompt = `Por favor, resume la siguiente conversación de manera concisa y clara, enfocándote en los puntos clave educativos: \n\n${chatTranscript}\n\nResumen:`;
            
            sendMessageToGemini(summaryPrompt, null, true);
        });

        // Botón "Generar Notas"
        generateNotesBtn.addEventListener('click', () => {
            if (!geminiApiKey) {
                alertUser("Clave de API de Gemini no configurada. Por favor, introducela.");
                apiKeyModal.classList.remove('hidden');
                return;
            }

            let notesPrompt;
            const currentInputText = userInput.value.trim();
            if (currentInputText) {
                notesPrompt = `Genera notas de estudio o puntos clave sobre el siguiente tema: "${currentInputText}". Presenta las notas en formato de lista.`;
                displayMessage(`Generando notas para: "${currentInputText}"`, 'user');
                saveMessage(`Generando notas para: "${currentInputText}"`, 'user');
                userInput.value = '';
            } else {
                const chatTranscript = chatHistory.map(msg => `${msg.sender === 'user' ? 'Tú' : 'AI'}: ${msg.text}`).join('\n');
                notesPrompt = `Basándote en la siguiente conversación, genera un resumen en formato de notas de estudio con los puntos clave: \n\n${chatTranscript}\n\nNotas de Estudio:`;
                displayMessage(`Generando notas de estudio basadas en la conversación.`, 'user');
                saveMessage(`Generando notas de estudio basadas en la conversación.`, 'user');
            }
            
            sendMessageToGemini(notesPrompt, null, true);
        });
    </script>
</body>
</html>
